# 同济Canvas批量签到器

一个专为同济大学Canvas系统课堂签到场景设计的Android批量签到应用。

## 📱 项目简介

针对同济大学Canvas系统课堂签到的场景，教室大屏幕上有一个5秒刷新一次的签到二维码，这个二维码对应内容是一个HTTPS链接。学生扫描这个二维码，打开链接，视为一次签到。学生在签到前需要通过OAuth统一认证平台登录一次，确保自己的cookie有效。

本应用实现了多人签到功能：多个用户事先通过统一认证平台登录，然后APP分别拦截并保存好每个用户的cookie，用这个APP扫描二维码，可以依次替换cookie打开，完成多个人的签到。

## ✨ 主要功能

### 🔐 用户认证管理
- **OAuth2.0统一认证登录**：支持同济大学统一认证平台登录
- **Cookie自动捕获**：自动提取并保存用户认证信息
- **多用户管理**：支持添加、编辑、删除多个用户
- **认证状态显示**：实时显示每个用户的认证状态

### 📷 智能二维码扫描
- **双引擎识别**：集成ML Kit和ZXing双重识别引擎
- **相机变焦控制**：支持手动和手势变焦，适应不同距离的二维码
- **自动对焦**：智能对焦系统，确保扫描清晰度
- **图像增强处理**：多版本图像处理，提高识别成功率
- **实时状态显示**：显示扫描进度和识别引擎状态

### 🎯 批量签到执行
- **多用户并发**：支持同时为多个用户执行签到
- **Cookie自动切换**：自动为每个用户设置对应的认证信息
- **签到状态监控**：实时显示每个用户的签到进度和结果
- **WebView集成**：使用WebView模拟浏览器访问，确保签到成功

### 🎨 现代化界面
- **Material Design 3**：采用最新的Material Design设计规范
- **响应式布局**：适配不同屏幕尺寸
- **流畅动画**：扫描线动画和状态切换动画
- **直观操作**：简洁易用的用户界面

## 🛠️ 技术栈

### 核心框架
- **Kotlin**：主要开发语言
- **Jetpack Compose**：现代化UI框架
- **Android Architecture Components**：MVVM架构模式

### 关键依赖
- **CameraX**：相机功能实现
- **ML Kit Barcode Scanning**：Google机器学习二维码识别
- **ZXing**：开源二维码识别库
- **WebView**：网页访问和Cookie管理
- **OkHttp**：网络请求处理
- **SharedPreferences**：本地数据存储

### 权限要求
- `CAMERA`：相机权限，用于二维码扫描
- `INTERNET`：网络权限，用于登录和签到

## 📦 项目结构

```
app/src/main/java/com/mln/tongji_canvas/
├── MainActivity.kt              # 主活动，导航控制
├── data/                       # 数据层
│   ├── SessionModels.kt        # 数据模型定义
│   └── SessionRepository.kt    # 数据存储管理
└── ui/                         # 界面层
    ├── MainScreen.kt           # 主界面，用户管理
    ├── OAuth2LoginScreen.kt    # OAuth2登录界面
    ├── EnhancedScannerScreen.kt # 增强扫描界面
    └── BatchSignScreen.kt      # 批量签到界面
```

## 🚀 快速开始

### 环境要求
- Android Studio Hedgehog 2023.1.1 或更高版本
- JDK 21
- Android SDK 34 (API Level 34)
- 最低支持Android 9.0 (API Level 28)

### 构建步骤

1. **克隆项目**
   ```bash
   git clone <repository-url>
   cd canvas_batch_sign
   ```

2. **打开项目**
   - 使用Android Studio打开项目根目录
   - 等待Gradle同步完成

3. **构建APK**
   ```bash
   ./gradlew assembleRelease
   ```
   生成的APK位于：`app/build/outputs/apk/release/`

4. **安装应用**
   ```bash
   adb install app/build/outputs/apk/release/app-arm64-v8a-release.apk
   ```

## 📖 使用指南

### 1. 添加用户
1. 点击主界面右下角的"添加用户"按钮
2. 选择"OAuth2登录"进入登录界面
3. 完成同济大学统一认证登录
4. 系统会自动捕获并保存认证信息
5. 输入用户昵称（可选）
6. 点击"保存"完成用户添加

### 2. 扫描签到码
1. 点击主界面右下角的"扫描签到码"按钮
2. 允许相机权限（首次使用）
3. 将相机对准教室大屏幕上的二维码
4. 可以使用变焦按钮或手势调整焦距
5. 系统会自动识别二维码并跳转到批量签到页面

### 3. 批量签到
1. 扫描成功后，系统会显示所有已添加的用户
2. 每个用户会显示认证状态和签到进度
3. 系统会自动为每个用户设置对应的认证信息
4. 等待所有用户签到完成

### 4. 用户管理
- **编辑用户**：点击用户卡片上的编辑按钮
- **删除用户**：点击用户卡片上的删除按钮
- **查看认证信息**：点击用户卡片查看详细认证状态

## ⚙️ 高级功能

### 用户代理切换
在OAuth2登录界面，可以切换手机模式和电脑模式：
- **手机模式**：模拟移动设备访问，适配移动端页面
- **电脑模式**：模拟桌面设备访问，适配桌面端页面

### 智能扫描优化
- **自适应扫描频率**：根据识别成功率自动调整扫描频率
- **多版本图像处理**：原始、增强、灰度、反色等多种处理方式
- **失败重试机制**：ML Kit失败时自动切换到ZXing引擎

### Cookie管理策略
- **自动Cookie清理**：每次登录前自动清除旧的认证信息
- **多域名支持**：同时支持Canvas和IAM域名的Cookie设置
- **认证信息验证**：实时检测认证信息变化并重新设置

## 🔧 配置说明

### 应用配置
- **应用ID**：`com.mln.tongji_canvas`
- **版本名称**：2.0.0
- **版本代码**：20251010
- **最小SDK**：28 (Android 9.0)
- **目标SDK**：36 (Android 14)

### 网络配置
- **允许明文传输**：`android:usesCleartextTraffic="true"`
- **网络安全配置**：支持HTTP和HTTPS混合访问

## 🐛 故障排除

### 常见问题

1. **相机权限被拒绝**
   - 解决方案：在系统设置中手动授予相机权限

2. **二维码识别失败**
   - 检查二维码是否清晰
   - 尝试调整相机焦距
   - 确保光线充足

3. **登录失败**
   - 检查网络连接
   - 确认统一认证平台是否正常
   - 尝试切换用户代理模式

4. **签到失败**
   - 检查认证信息是否有效
   - 确认目标URL是否正确
   - 重新添加用户认证信息

### 调试模式
应用包含详细的日志输出，可以通过Android Studio的Logcat查看调试信息：
- 标签：`EnhancedScannerScreen`、`OAuth2LoginScreen`、`BatchSignScreen`

## 📄 许可证

本项目仅供学习和研究使用，请遵守同济大学相关规定和Canvas系统的使用条款。

## 👨‍💻 开发者

- **开发者**：mmmlllnnn
- **GitHub**：[@mmmlllnnn](https://github.com/mmmlllnnn)
- **项目地址**：[TongJi_Canvas](https://github.com/mmmlllnnn/TongJi_Canvas)

## 📝 更新日志

### v2.0.0 (2025-01-10)
- 🎉 全新Material Design 3界面设计
- 🔧 优化OAuth2登录流程
- 📷 增强二维码扫描功能
- 🚀 改进批量签到性能
- 🐛 修复多个已知问题

### v1.0.0
- 🎯 初始版本发布
- ✨ 基础批量签到功能
- 🔐 OAuth2认证支持
- 📱 简单用户界面

---

**注意**：本应用仅用于合法的课堂签到场景，请勿用于其他用途。使用前请确保已获得相关授权。
